<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta name="theme-color" content="#ff8c42">
<meta name="description" content="App para registrar horas de trabajo y descanso">
<link rel="manifest" href="manifest.json">
<link rel="icon" href="icons/icon-192.png">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<title>Regyster - Registro de Trabajo</title>
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #0a0e27 0%, #1a1a2e 50%, #16213e 100%);
    min-height: 100vh;
    padding: 30px 20px;
    color: #e0e0e0;
  }

  .contenedor {
    max-width: 700px;
    margin: 0 auto;
  }

  h2 {
    text-align: center;
    font-size: 2.2em;
    background: linear-gradient(135deg, #ff8c42 0%, #ff6b35 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin: 30px 0 25px 0;
    text-transform: uppercase;
    font-weight: 900;
    letter-spacing: 2px;
  }

  .seccion {
    background: linear-gradient(135deg, rgba(26, 26, 46, 0.8) 0%, rgba(22, 33, 62, 0.8) 100%);
    border: 2px solid rgba(255, 140, 66, 0.3);
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 25px;
    box-shadow: 0 0 30px rgba(255, 140, 66, 0.15), inset 0 0 30px rgba(255, 140, 66, 0.05);
    backdrop-filter: blur(10px);
    position: relative;
    overflow: hidden;
  }

  .seccion::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 140, 66, 0.1), transparent);
    animation: brillo 3s infinite;
    pointer-events: none;
  }

  @keyframes brillo {
    0% { left: -100%; }
    50% { left: 100%; }
    100% { left: 100%; }
  }

  label {
    display: block;
    margin-top: 18px;
    font-weight: 700;
    color: #ff8c42;
    font-size: 1.05em;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  select, input[type="date"], input[type="month"], input[type="time"], input[type="datetime-local"] {
    margin: 10px auto;
    padding: 14px 16px;
    font-size: 1.05em;
    width: 100%;
    border-radius: 8px;
    border: 2px solid rgba(255, 140, 66, 0.4);
    background: rgba(10, 14, 39, 0.6);
    color: #ff8c42;
    display: block;
    transition: all 0.3s ease;
    cursor: pointer;
    font-weight: 600;
  }

  select:hover, input[type="date"]:hover, input[type="month"]:hover, input[type="time"]:hover, input[type="datetime-local"]:hover {
    border-color: #ff8c42;
    box-shadow: 0 0 15px rgba(255, 140, 66, 0.4);
  }

  select:focus, input[type="date"]:focus, input[type="month"]:focus, input[type="time"]:focus, input[type="datetime-local"]:focus {
    outline: none;
    border-color: #ff6b35;
    box-shadow: 0 0 25px rgba(255, 140, 66, 0.6);
  }

  select option {
    background: #1a1a2e;
    color: #ff8c42;
  }

  input[type="checkbox"] {
    width: 20px;
    height: 20px;
    margin-right: 10px;
    cursor: pointer;
    accent-color: #ff8c42;
  }

  .checkbox-label {
    display: flex;
    align-items: center;
    cursor: pointer;
    font-size: 1.05em;
    color: #e0e0e0;
    margin-top: 15px;
  }

  .checkbox-label:hover {
    color: #ff8c42;
  }

  .cronometro-container {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
    margin: 25px 0;
    flex-wrap: wrap;
  }

  .reloj {
    background: rgba(255, 140, 66, 0.15);
    border: 3px solid #ff8c42;
    border-radius: 12px;
    padding: 16px 28px;
    font-size: 1.6em;
    font-weight: bold;
    color: #ff8c42;
    font-family: 'Courier New', monospace;
    min-width: 280px;
    text-align: center;
    box-shadow: 0 0 20px rgba(255, 140, 66, 0.4);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
  }

  .reloj.activo {
    animation: pulso 1s infinite;
  }

  @keyframes pulso {
    0%, 100% { box-shadow: 0 0 20px rgba(255, 140, 66, 0.4); }
    50% { box-shadow: 0 0 35px rgba(255, 140, 66, 0.8); }
  }

  .icono-reloj {
    font-size: 2em;
    min-width: 50px;
  }

  .tiempo-reloj {
    letter-spacing: 2px;
  }

  button {
    background: linear-gradient(135deg, #ff8c42 0%, #ff6b35 100%);
    color: #0a0e27;
    border: none;
    padding: 14px 32px;
    font-size: 1.1em;
    font-weight: 800;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    margin: 15px auto;
    display: block;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  button:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 30px rgba(255, 140, 66, 0.5);
  }

  #botonCrono {
    min-width: 120px;
    padding: 14px 20px;
  }

  #botonAjuste {
    min-width: 50px;
    width: 50px;
    height: 50px;
    padding: 0;
    font-size: 1.3em;
    border-radius: 8px;
  }

  #botonGuardar {
    background: linear-gradient(135deg, #ff3333 0%, #cc0000 100%);
    border: 3px solid #ff6666;
    box-shadow: 0 0 20px rgba(255, 51, 51, 0.4);
    margin-top: 30px;
  }

  .entry {
    padding: 16px;
    margin-top: 12px;
    border-radius: 8px;
    background: rgba(255, 140, 66, 0.08);
    border-left: 4px solid #ff8c42;
    box-shadow: 0 4px 12px rgba(255, 140, 66, 0.15);
    text-align: left;
  }

  .resumen {
    padding: 20px;
    margin-top: 15px;
    border-radius: 8px;
    background: linear-gradient(135deg, #ff8c42 0%, #ff6b35 100%);
    border: 2px solid #ff6b35;
    box-shadow: 0 0 20px rgba(255, 140, 66, 0.4);
    text-align: left;
  }

  .resumen h3 {
    margin: 0 0 15px 0;
    color: #000;
    text-align: center;
    font-size: 1.3em;
    font-weight: 900;
  }

  .resumen-item {
    margin-bottom: 12px;
    padding: 10px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 6px;
    border-left: 3px solid #000;
    font-size: 0.9em;
  }

  .resumen-item span {
    font-weight: bold;
    color: #000;
  }

  .detalle-dia {
    margin-left: 20px;
    font-size: 0.9em;
    color: #000;
    padding: 5px 0;
  }

  .estado-crono {
    text-align: center;
    color: #ff8c42;
    font-size: 0.9em;
    margin-top: 8px;
    font-weight: 600;
  }

  .separador {
    height: 2px;
    background: linear-gradient(90deg, transparent, #ff8c42, transparent);
    margin: 30px 0;
  }

  /* Estilos para el modal */
  .modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(10, 14, 39, 0.95);
    overflow-y: auto;
  }

  .modal-content {
    background: linear-gradient(135deg, rgba(26, 26, 46, 0.95) 0%, rgba(22, 33, 62, 0.95) 100%);
    margin: 5% auto;
    padding: 30px;
    border: 3px solid #ff8c42;
    border-radius: 15px;
    width: 90%;
    max-width: 600px;
    box-shadow: 0 0 50px rgba(255, 140, 66, 0.5);
  }

  .close {
    color: #ff8c42;
    float: right;
    font-size: 35px;
    font-weight: bold;
    cursor: pointer;
    line-height: 20px;
  }

  .close:hover {
    color: #ff6b35;
  }

  .modal h3 {
    color: #ff8c42;
    text-align: center;
    margin-bottom: 20px;
    font-size: 1.5em;
  }

  .form-group {
    margin-bottom: 15px;
  }

  .form-group label {
    font-size: 0.95em;
    margin-bottom: 5px;
  }

  .btn-confirmar {
    background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
    margin-top: 20px;
  }

  .btn-cancelar {
    background: linear-gradient(135deg, #666 0%, #555 100%);
    margin-top: 10px;
  }

  /* Estilos para el calendario */
  .calendario {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 8px;
    margin-top: 20px;
  }

  .dia-semana {
    text-align: center;
    font-weight: bold;
    color: #ff8c42;
    padding: 10px 5px;
    font-size: 0.9em;
  }

  .dia-calendario {
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px solid rgba(255, 140, 66, 0.3);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 600;
    background: rgba(255, 255, 255, 0.05);
  }

  .dia-calendario:hover {
    transform: scale(1.05);
    box-shadow: 0 0 15px rgba(255, 140, 66, 0.5);
  }

  .dia-trabajado {
    background: rgba(255, 51, 51, 0.7) !important;
    border-color: #ff3333;
    color: #fff;
  }

  .dia-vacio {
    background: transparent;
    border: none;
    cursor: default;
  }

  .dia-vacio:hover {
    transform: none;
    box-shadow: none;
  }

  .panel-ajuste {
    display: none;
    background: rgba(26, 26, 46, 0.95);
    border: 2px solid #ff8c42;
    border-radius: 10px;
    padding: 20px;
    margin-top: 15px;
  }

  .panel-ajuste.activo {
    display: block;
  }

  input[type="number"] {
    margin: 10px auto;
    padding: 14px 16px;
    font-size: 1.05em;
    width: 100%;
    border-radius: 8px;
    border: 2px solid rgba(255, 140, 66, 0.4);
    background: rgba(10, 14, 39, 0.6);
    color: #ff8c42;
    display: block;
    transition: all 0.3s ease;
    font-weight: 600;
  }

  input[type="number"]:focus {
    outline: none;
    border-color: #ff6b35;
    box-shadow: 0 0 25px rgba(255, 140, 66, 0.6);
  }
</style>
</head>
<body>

<div class="contenedor">

  <h2>‚öîÔ∏è Regyster ‚öîÔ∏è</h2>

  <div class="seccion">
    <label class="checkbox-label">
      <input type="checkbox" id="festivo" /> üéâ Festivo
    </label>

    <label class="checkbox-label">
      <input type="checkbox" id="sexto" /> ‚ö° Sexto d√≠a consecutivo
    </label>

    <label>üõèÔ∏è Dieta Pernocta</label>
    <select id="dieta_pernocta">
      <option value="casa">En casa</option>
      <option value="camion">En cami√≥n</option>
    </select>

    <div class="cronometro-container">
      <button id="botonAjuste">‚öôÔ∏è</button>
      <div class="reloj" id="reloj">
        <div class="icono-reloj" id="iconoReloj">‚è±Ô∏è</div>
        <div class="tiempo-reloj" id="tiempoReloj">00:00:00</div>
      </div>
      <button id="botonCrono">‚è±Ô∏è</button>
    </div>
    <div class="estado-crono" id="estadoCrono">Presiona el reloj para comenzar</div>
    <div class="estado-crono" id="horaInicio" style="font-size: 0.85em; margin-top: 5px; color: #ff8c42;"></div>

    <!-- Panel de ajuste manual -->
    <div class="panel-ajuste" id="panelAjuste">
      <h3 style="color: #ff8c42; text-align: center; margin-bottom: 15px;">‚öôÔ∏è Ajuste Manual</h3>
      
      <label>Fecha y Hora de Inicio</label>
      <input type="datetime-local" id="ajusteInicio" />
      
      <label>Fecha y Hora de Fin (opcional)</label>
      <input type="datetime-local" id="ajusteFin" />
      
      <button class="btn-confirmar" id="btnConfirmarAjuste">‚úì Confirmar</button>
      <button class="btn-cancelar" id="btnCancelarAjuste">‚úó Cancelar</button>
    </div>

    <button id="botonGuardar">üíæ GUARDAR DIETA</button>
  </div>

  <div class="separador"></div>

  <h2>üìã Historial</h2>
  <div class="seccion">
    <div id="historial"></div>
  </div>

  <div class="separador"></div>

  <h2>üìä Res√∫menes</h2>

  <div class="seccion">
    <label>Resumen Normal (Mes Completo)</label>
    <input type="month" id="mesResumen" />
    <button id="resumenMes">üìà Mostrar Resumen Mensual</button>
    <div id="resumen"></div>
  </div>

  <div class="seccion">
    <label>Resumen 26‚Üí25 (Ciclo Laboral)</label>
    <input type="month" id="mesResumenReal" />
    <button id="btnResumenReal">üìà Mostrar Resumen 26‚Üí25</button>
    <div id="resumenRealContainer"></div>
  </div>

</div>

<!-- Modal para detalles del d√≠a -->
<div id="modalDetalle" class="modal">
  <div class="modal-content">
    <span class="close" id="closeModal">&times;</span>
    <h3 id="tituloModal">Detalles del D√≠a</h3>
    <div id="contenidoModal"></div>
    <button class="btn-confirmar" id="btnGuardarCambios" style="display:none;">üíæ Guardar Cambios</button>
  </div>
</div>

<script>
  // Registrar Service Worker
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('service-worker.js').catch(err => {
        console.log('SW error:', err);
      });
    });
  }

  // ========== VARIABLES GLOBALES ==========
  let cronoActivo = false;
  let enTrabajo = true;
  let tiempoInicio = null;
  let tiempoTranscurrido = 0;
  let sesionActual = null; // Para guardar inicio de sesi√≥n actual
  let modoEdicion = false;
  let diaEditando = null;

  // ========== PERSISTENCIA DEL CRON√ìMETRO ==========
  
  function guardarEstadoCrono() {
    const estado = {
      cronoActivo: cronoActivo,
      enTrabajo: enTrabajo,
      tiempoInicio: tiempoInicio,
      tiempoTranscurrido: tiempoTranscurrido,
      sesionActual: sesionActual
    };
    localStorage.setItem('estadoCrono', JSON.stringify(estado));
  }

  function cargarEstadoCrono() {
    const estadoGuardado = localStorage.getItem('estadoCrono');
    if (estadoGuardado) {
      const estado = JSON.parse(estadoGuardado);
      cronoActivo = estado.cronoActivo;
      enTrabajo = estado.enTrabajo;
      tiempoInicio = estado.tiempoInicio;
      tiempoTranscurrido = estado.tiempoTranscurrido;
      sesionActual = estado.sesionActual;
      
      if (cronoActivo) {
        actualizarReloj();
      } else if (sesionActual) {
        // Mostrar √∫ltima hora de inicio aunque no est√© activo
        mostrarHoraInicio();
      }
    }
  }

  function mostrarHoraInicio() {
    const horaInicioEl = document.getElementById('horaInicio');
    if (sesionActual && sesionActual.fechaInicio) {
      const fecha = new Date(sesionActual.fechaInicio);
      const hora = fecha.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
      const tipo = sesionActual.tipo === 'trabajo' ? 'Trabajo' : 'Descanso';
      horaInicioEl.textContent = `Desde las ${hora}`;
    } else {
      horaInicioEl.textContent = '';
    }
  }

  // ========== FUNCIONES DE UTILIDAD ==========
  
  function formatearTiempo(ms){
    const totalSegundos = Math.floor(ms / 1000);
    const horas = Math.floor(totalSegundos / 3600);
    const minutos = Math.floor((totalSegundos % 3600) / 60);
    const segundos = totalSegundos % 60;
    return `${String(horas).padStart(2,'0')}:${String(minutos).padStart(2,'0')}:${String(segundos).padStart(2,'0')}`;
  }

  function calcularHorasNocturnas(fechaInicio, fechaFin) {
    const inicio = new Date(fechaInicio);
    const fin = new Date(fechaFin);
    let horasNocturnas = 0;
    
    const current = new Date(inicio);
    while (current < fin) {
      const hora = current.getHours();
      if (hora >= 22 || hora < 6) {
        horasNocturnas += 1/60; // Incremento por minuto
      }
      current.setMinutes(current.getMinutes() + 1);
    }
    
    return Math.round(horasNocturnas * 10) / 10;
  }

  function obtenerFechaString(fecha) {
    const f = new Date(fecha);
    const year = f.getFullYear();
    const month = String(f.getMonth() + 1).padStart(2, '0');
    const day = String(f.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  }

  function formatearFechaHora(fecha) {
    const f = new Date(fecha);
    return f.toLocaleString('es-ES', { 
      day: '2-digit', 
      month: '2-digit', 
      year: 'numeric',
      hour: '2-digit', 
      minute: '2-digit' 
    });
  }

  // ========== CRON√ìMETRO ==========

  function actualizarReloj(){
    const tiempoReloj = document.getElementById('tiempoReloj');
    const iconoReloj = document.getElementById('iconoReloj');
    const estadoCrono = document.getElementById('estadoCrono');
    const reloj = document.getElementById('reloj');

    if(cronoActivo){
      const ahora = Date.now();
      const total = tiempoTranscurrido + (ahora - tiempoInicio);
      tiempoReloj.textContent = formatearTiempo(total);
      iconoReloj.textContent = enTrabajo ? 'üîß' : 'üõèÔ∏è';
      estadoCrono.textContent = enTrabajo ? '‚è±Ô∏è Trabajando...' : '‚è±Ô∏è Descansando...';
      mostrarHoraInicio();
      reloj.classList.add('activo');
      guardarEstadoCrono();
      requestAnimationFrame(actualizarReloj);
    } else {
      reloj.classList.remove('activo');
      iconoReloj.textContent = '‚è±Ô∏è';
      if (!sesionActual) {
        estadoCrono.textContent = 'Presiona el reloj para comenzar';
        document.getElementById('horaInicio').textContent = '';
      } else {
        estadoCrono.textContent = enTrabajo ? '‚è±Ô∏è Trabajo pausado' : '‚è±Ô∏è Descanso pausado';
        mostrarHoraInicio();
      }
      guardarEstadoCrono();
    }
  }

  document.getElementById('botonCrono').onclick = function(){
    if(!cronoActivo){
      // Iniciar cron√≥metro
      cronoActivo = true;
      tiempoInicio = Date.now();
      
      if (!sesionActual) {
        sesionActual = {
          fechaInicio: new Date(tiempoInicio),
          tipo: 'trabajo'
        };
        enTrabajo = true;
      }
      
      guardarEstadoCrono();
      actualizarReloj();
    } else {
      // Detener cron√≥metro
      cronoActivo = false;
      const ahora = Date.now();
      tiempoTranscurrido += (ahora - tiempoInicio);
      
      if (sesionActual) {
        const fechaFin = new Date(ahora);
        const duracionHoras = tiempoTranscurrido / 1000 / 3600;
        
        // Guardar la sesi√≥n
        guardarSesion(sesionActual.fechaInicio, fechaFin, sesionActual.tipo, duracionHoras);
        
        // Cambiar autom√°ticamente entre trabajo y descanso
        enTrabajo = !enTrabajo;
        sesionActual = {
          fechaInicio: fechaFin,
          tipo: enTrabajo ? 'trabajo' : 'descanso'
        };
        
        // Iniciar autom√°ticamente el siguiente per√≠odo
        tiempoTranscurrido = 0;
        tiempoInicio = ahora;
        cronoActivo = true;
      }
      
      guardarEstadoCrono();
      actualizarReloj();
      cargarHistorial();
    }
  };

  function guardarSesion(inicio, fin, tipo, duracion) {
    const jornadas = JSON.parse(localStorage.getItem('jornadas') || '[]');
    
    const horasNocturnas = tipo === 'trabajo' ? calcularHorasNocturnas(inicio, fin) : 0;
    
    const nuevaSesion = {
      fechaInicio: inicio.toISOString(),
      fechaFin: fin.toISOString(),
      tipo: tipo,
      duracion: Math.round(duracion * 100) / 100,
      horasNocturnas: horasNocturnas,
      timestamp: Date.now()
    };
    
    jornadas.push(nuevaSesion);
    localStorage.setItem('jornadas', JSON.stringify(jornadas));
    
    console.log('Sesi√≥n guardada:', nuevaSesion);
  }

  // ========== PANEL DE AJUSTE MANUAL ==========

  document.getElementById('botonAjuste').onclick = function() {
    const panel = document.getElementById('panelAjuste');
    panel.classList.toggle('activo');
  };

  document.getElementById('btnCancelarAjuste').onclick = function() {
    document.getElementById('panelAjuste').classList.remove('activo');
    document.getElementById('ajusteInicio').value = '';
    document.getElementById('ajusteFin').value = '';
  };

  document.getElementById('btnConfirmarAjuste').onclick = function() {
    const inicioValue = document.getElementById('ajusteInicio').value;
    const finValue = document.getElementById('ajusteFin').value;
    
    if (!inicioValue) {
      alert('Debes seleccionar al menos la fecha y hora de inicio');
      return;
    }
    
    const fechaInicio = new Date(inicioValue);
    
    if (finValue) {
      // Guardar jornada completa
      const fechaFin = new Date(finValue);
      const duracionMs = fechaFin - fechaInicio;
      const duracionHoras = duracionMs / 1000 / 3600;
      
      if (duracionHoras <= 0) {
        alert('La fecha de fin debe ser posterior a la fecha de inicio');
        return;
      }
      
      guardarSesion(fechaInicio, fechaFin, 'trabajo', duracionHoras);
      
      alert('Jornada guardada correctamente');
      document.getElementById('panelAjuste').classList.remove('activo');
      document.getElementById('ajusteInicio').value = '';
      document.getElementById('ajusteFin').value = '';
      cargarHistorial();
    } else {
      // Ajustar inicio del cron√≥metro actual
      tiempoInicio = fechaInicio.getTime();
      tiempoTranscurrido = Date.now() - tiempoInicio;
      
      if (!cronoActivo) {
        cronoActivo = true;
        sesionActual = {
          fechaInicio: fechaInicio,
          tipo: 'trabajo'
        };
        enTrabajo = true;
      } else {
        // Si ya est√° activo, solo actualizar la hora de inicio
        sesionActual.fechaInicio = fechaInicio;
      }
      
      guardarEstadoCrono();
      actualizarReloj();
      document.getElementById('panelAjuste').classList.remove('activo');
      document.getElementById('ajusteInicio').value = '';
      alert('Hora de inicio ajustada correctamente');
    }
  };

  // ========== GUARDAR DIETA ==========

  document.getElementById('botonGuardar').onclick = () => {
    const dieta = document.getElementById('dieta_pernocta').value;
    const fest = document.getElementById('festivo').checked;
    const sexto = document.getElementById('sexto').checked;
    
    const hoy = obtenerFechaString(new Date());
    
    const registros = JSON.parse(localStorage.getItem('registros') || "[]");
    
    // Buscar si ya existe registro para hoy
    const indice = registros.findIndex(r => r.fecha === hoy);
    
    if (indice >= 0) {
      registros[indice].dieta_pernocta = dieta;
      registros[indice].festivo = fest;
      registros[indice].sexto = sexto;
    } else {
      registros.push({
        fecha: hoy, 
        dieta_pernocta: dieta, 
        festivo: fest, 
        sexto: sexto
      });
    }
    
    localStorage.setItem('registros', JSON.stringify(registros));
    cargarHistorial();
    alert('Dieta guardada correctamente');
  };

  // ========== HISTORIAL ==========

  function cargarHistorial(){
    const cont = document.getElementById('historial');
    cont.innerHTML = "";
    
    const jornadas = JSON.parse(localStorage.getItem('jornadas') || "[]");
    const registros = JSON.parse(localStorage.getItem('registros') || "[]");
    
    if(jornadas.length === 0 && registros.length === 0){
      cont.innerHTML = "<div class='entry'>No hay registros a√∫n.</div>";
      return;
    }
    
    // Mostrar √∫ltimas 10 jornadas
    const ultimasJornadas = jornadas.slice(-10).reverse();
    
    ultimasJornadas.forEach(j => {
      const div = document.createElement('div');
      div.className = 'entry';
      div.innerHTML = `
        <b style="color: #ff8c42;">Tipo:</b> ${j.tipo === 'trabajo' ? 'üîß Trabajo' : 'üõèÔ∏è Descanso'}<br>
        <b style="color: #ff8c42;">Inicio:</b> ${formatearFechaHora(j.fechaInicio)}<br>
        <b style="color: #ff8c42;">Fin:</b> ${formatearFechaHora(j.fechaFin)}<br>
        <b style="color: #ff8c42;">Duraci√≥n:</b> ${j.duracion.toFixed(2)}h
        ${j.tipo === 'trabajo' ? `<br><b style="color: #ff8c42;">Horas nocturnas:</b> ${j.horasNocturnas}h` : ''}
      `;
      cont.appendChild(div);
    });
  }

  // ========== RESUMEN MENSUAL NORMAL ==========

  document.getElementById('resumenMes').onclick = function(){
    const mes = document.getElementById('mesResumen').value;
    if(!mes){ alert('Selecciona mes'); return; }
    
    const [anio, mesNum] = mes.split('-');
    const registros = JSON.parse(localStorage.getItem('registros') || "[]");
    const jornadas = JSON.parse(localStorage.getItem('jornadas') || "[]");
    
    const filtrados = registros.filter(r => r.fecha && r.fecha.startsWith(anio + '-' + mesNum));
    const jornadasMes = jornadas.filter(j => {
      const fecha = obtenerFechaString(new Date(j.fechaInicio));
      return fecha.startsWith(anio + '-' + mesNum);
    });
    
    let html = '<div class="resumen"><h3>‚ú® Resumen ‚ú®</h3>';
    
    let totalHorasTrabajo = 0;
    let totalHorasDescanso = 0;
    let totalNocturnas = 0;
    let festivos = 0;
    let sextos = 0;
    let camion = 0;
    let casa = 0;
    
    jornadasMes.forEach(j => {
      if (j.tipo === 'trabajo') {
        totalHorasTrabajo += j.duracion;
        totalNocturnas += j.horasNocturnas || 0;
      } else {
        totalHorasDescanso += j.duracion;
      }
    });
    
    filtrados.forEach(r => {
      if(r.festivo) festivos++;
      if(r.sexto) sextos++;
      if(r.dieta_pernocta === 'camion') camion++;
      if(r.dieta_pernocta === 'casa') casa++;
    });
    
    html += `<div class="resumen-item"><span>D√≠as registrados:</span> <span style="color: #000; font-weight: bold; font-size: 1.05em;">${filtrados.length}</span></div>`;
    html += `<div class="resumen-item"><span>Horas trabajadas:</span> <span style="color: #000; font-weight: bold; font-size: 1.05em;">${totalHorasTrabajo.toFixed(2)}h</span></div>`;
    html += `<div class="resumen-item"><span>Horas descansadas:</span> <span style="color: #000; font-weight: bold; font-size: 1.05em;">${totalHorasDescanso.toFixed(2)}h</span></div>`;
    html += `<div class="resumen-item"><span>Horas nocturnas:</span> <span style="color: #000; font-weight: bold; font-size: 1.05em;">${totalNocturnas.toFixed(1)}h</span></div>`;
    html += `<div class="resumen-item"><span>D√≠as festivos:</span> <span style="color: #000; font-weight: bold; font-size: 1.05em;">${festivos}</span></div>`;
    html += `<div class="resumen-item"><span>Sextos d√≠as:</span> <span style="color: #000; font-weight: bold; font-size: 1.05em;">${sextos}</span></div>`;
    html += `<div class="resumen-item"><span>D√≠as en cami√≥n:</span> <span style="color: #000; font-weight: bold; font-size: 1.05em;">${camion}</span></div>`;
    html += `<div class="resumen-item"><span>D√≠as en casa:</span> <span style="color: #000; font-weight: bold; font-size: 1.05em;">${casa}</span></div>`;
    html += '</div>';
    
    document.getElementById('resumen').innerHTML = html;
  };

  // ========== RESUMEN 26‚Üí25 CON CALENDARIO ==========

  document.getElementById('btnResumenReal').onclick = function(){
    const mes = document.getElementById('mesResumenReal').value;
    if(!mes){ alert('Selecciona mes'); return; }
    
    mostrarCalendario2625(mes);
  };

  function mostrarCalendario2625(mes) {
    const [anio, mesNum] = mes.split('-');
    const mesInt = parseInt(mesNum);
    
    // Calcular rango de fechas (d√≠a 26 del mes anterior al d√≠a 25 del mes seleccionado)
    const fechaInicio = new Date(anio, mesInt - 2, 26); // Mes anterior, d√≠a 26
    const fechaFin = new Date(anio, mesInt - 1, 25, 23, 59, 59); // Mes seleccionado, d√≠a 25
    
    const jornadas = JSON.parse(localStorage.getItem('jornadas') || '[]');
    const registros = JSON.parse(localStorage.getItem('registros') || '[]');
    
    // Obtener d√≠as trabajados en el rango
    const diasTrabajados = new Set();
    jornadas.forEach(j => {
      if (j.tipo !== 'trabajo') return;
      
      const inicio = new Date(j.fechaInicio);
      const fin = new Date(j.fechaFin);
      
      // Marcar el d√≠a de inicio
      if (inicio >= fechaInicio && inicio <= fechaFin) {
        diasTrabajados.add(obtenerFechaString(inicio));
      }
      
      // Si la jornada abarca dos d√≠as, marcar tambi√©n el d√≠a de fin
      if (fin >= fechaInicio && fin <= fechaFin && obtenerFechaString(inicio) !== obtenerFechaString(fin)) {
        diasTrabajados.add(obtenerFechaString(fin));
      }
    });
    
    // Generar calendario
    let html = '<div class="resumen"><h3>üìÖ Calendario 26‚Üí25</h3>';
    html += '<div class="calendario">';
    
    // D√≠as de la semana
    const diasSemana = ['L', 'M', 'X', 'J', 'V', 'S', 'D'];
    diasSemana.forEach(dia => {
      html += `<div class="dia-semana">${dia}</div>`;
    });
    
    // Calcular d√≠a de la semana del primer d√≠a (26)
    const primerDia = new Date(fechaInicio);
    let diaSemana = primerDia.getDay();
    diaSemana = diaSemana === 0 ? 6 : diaSemana - 1; // Ajustar para que lunes sea 0
    
    // Espacios vac√≠os antes del primer d√≠a
    for (let i = 0; i < diaSemana; i++) {
      html += '<div class="dia-calendario dia-vacio"></div>';
    }
    
    // D√≠as del calendario
    const diaActual = new Date(fechaInicio);
    while (diaActual <= fechaFin) {
      const fechaStr = obtenerFechaString(diaActual);
      const esTrabajado = diasTrabajados.has(fechaStr);
      const clase = esTrabajado ? 'dia-calendario dia-trabajado' : 'dia-calendario';
      
      html += `<div class="${clase}" onclick="mostrarDetalleDia('${fechaStr}')">${diaActual.getDate()}</div>`;
      
      diaActual.setDate(diaActual.getDate() + 1);
    }
    
    html += '</div></div>';
    
    document.getElementById('resumenRealContainer').innerHTML = html;
  }

  // ========== MODAL DE DETALLES DEL D√çA ==========

  function mostrarDetalleDia(fecha) {
    const modal = document.getElementById('modalDetalle');
    const titulo = document.getElementById('tituloModal');
    const contenido = document.getElementById('contenidoModal');
    
    titulo.textContent = `Detalles del ${fecha}`;
    
    const jornadas = JSON.parse(localStorage.getItem('jornadas') || '[]');
    const registros = JSON.parse(localStorage.getItem('registros') || '[]');
    
    // Buscar jornadas de este d√≠a
    const jornadasDia = jornadas.filter(j => {
      const inicioStr = obtenerFechaString(new Date(j.fechaInicio));
      const finStr = obtenerFechaString(new Date(j.fechaFin));
      return inicioStr === fecha || finStr === fecha;
    });
    
    // Buscar registro de dieta
    const registro = registros.find(r => r.fecha === fecha);
    
    let html = '';
    
    if (jornadasDia.length === 0) {
      // D√≠a sin datos - mostrar todo en blanco/cero
      html += '<p style="color: #ff8c42; text-align: center; margin: 20px 0;">üì≠ D√≠a de descanso completo</p>';
      html += '<div class="entry">';
      html += '<b style="color: #ff8c42;">Horas trabajadas:</b> 0h<br>';
      html += '<b style="color: #ff8c42;">Horas descansadas:</b> 24h<br>';
      html += '<b style="color: #ff8c42;">Horas nocturnas:</b> 0h<br>';
      html += '<b style="color: #ff8c42;">Festivo:</b> No<br>';
      html += '<b style="color: #ff8c42;">Sexto d√≠a:</b> No<br>';
      html += '<b style="color: #ff8c42;">Dieta:</b> -<br>';
      html += '</div>';
      
      html += '<button onclick="habilitarEdicion(\'' + fecha + '\')" class="btn-confirmar" style="margin-top: 15px;">‚úèÔ∏è Modificar Datos</button>';
    } else {
      // D√≠a con datos
      let totalTrabajo = 0;
      let totalDescanso = 0;
      let totalNocturnas = 0;
      
      html += '<div style="max-height: 400px; overflow-y: auto;">';
      
      jornadasDia.forEach(j => {
        const inicio = new Date(j.fechaInicio);
        const fin = new Date(j.fechaFin);
        const inicioStr = obtenerFechaString(inicio);
        const finStr = obtenerFechaString(fin);
        
        if (j.tipo === 'trabajo') {
          totalTrabajo += j.duracion;
          totalNocturnas += j.horasNocturnas || 0;
        } else {
          totalDescanso += j.duracion;
        }
        
        html += '<div class="entry">';
        html += `<b style="color: #ff8c42;">Tipo:</b> ${j.tipo === 'trabajo' ? 'üîß Trabajo' : 'üõèÔ∏è Descanso'}<br>`;
        
        if (inicioStr !== fecha) {
          html += `<b style="color: #ff8c42;">‚ö†Ô∏è Inicio:</b> ${formatearFechaHora(inicio)} <i>(d√≠a anterior)</i><br>`;
        } else {
          html += `<b style="color: #ff8c42;">Inicio:</b> ${formatearFechaHora(inicio)}<br>`;
        }
        
        if (finStr !== fecha) {
          html += `<b style="color: #ff8c42;">‚ö†Ô∏è Fin:</b> ${formatearFechaHora(fin)} <i>(d√≠a siguiente)</i><br>`;
        } else {
          html += `<b style="color: #ff8c42;">Fin:</b> ${formatearFechaHora(fin)}<br>`;
        }
        
        html += `<b style="color: #ff8c42;">Duraci√≥n:</b> ${j.duracion.toFixed(2)}h<br>`;
        
        if (j.tipo === 'trabajo' && j.horasNocturnas > 0) {
          html += `<b style="color: #ff8c42;">Horas nocturnas:</b> ${j.horasNocturnas.toFixed(1)}h<br>`;
        }
        
        html += '</div>';
      });
      
      html += '</div>';
      
      // Resumen del d√≠a
      html += '<div class="resumen" style="margin-top: 15px;">';
      html += '<h3 style="font-size: 1.1em;">Resumen del D√≠a</h3>';
      html += `<div class="resumen-item"><span>Total trabajo:</span> <span>${totalTrabajo.toFixed(2)}h</span></div>`;
      html += `<div class="resumen-item"><span>Total descanso:</span> <span>${totalDescanso.toFixed(2)}h</span></div>`;
      html += `<div class="resumen-item"><span>Horas nocturnas:</span> <span>${totalNocturnas.toFixed(1)}h</span></div>`;
      
      if (registro) {
        html += `<div class="resumen-item"><span>Festivo:</span> <span>${registro.festivo ? 'S√≠' : 'No'}</span></div>`;
        html += `<div class="resumen-item"><span>Sexto d√≠a:</span> <span>${registro.sexto ? 'S√≠' : 'No'}</span></div>`;
        html += `<div class="resumen-item"><span>Dieta:</span> <span>${registro.dieta_pernocta === 'camion' ? 'En cami√≥n' : 'En casa'}</span></div>`;
      }
      
      html += '</div>';
      
      html += '<button onclick="habilitarEdicion(\'' + fecha + '\')" class="btn-confirmar" style="margin-top: 15px;">‚úèÔ∏è Modificar Datos</button>';
    }
    
    contenido.innerHTML = html;
    modal.style.display = 'block';
  }

  function habilitarEdicion(fecha) {
    const contenido = document.getElementById('contenidoModal');
    const jornadas = JSON.parse(localStorage.getItem('jornadas') || '[]');
    const registros = JSON.parse(localStorage.getItem('registros') || '[]');
    
    const jornadasDia = jornadas.filter(j => {
      const inicioStr = obtenerFechaString(new Date(j.fechaInicio));
      const finStr = obtenerFechaString(new Date(j.fechaFin));
      return inicioStr === fecha || finStr === fecha;
    });
    
    const registro = registros.find(r => r.fecha === fecha) || {
      fecha: fecha,
      festivo: false,
      sexto: false,
      dieta_pernocta: 'casa'
    };
    
    let html = '<div style="max-height: 400px; overflow-y: auto;">';
    html += '<h4 style="color: #ff8c42; margin-bottom: 15px;">Editar Datos Manualmente</h4>';
    
    html += '<label>Fecha y Hora de Inicio</label>';
    html += '<input type="datetime-local" id="editInicio" />';
    
    html += '<label>Fecha y Hora de Fin</label>';
    html += '<input type="datetime-local" id="editFin" />';
    
    html += '<label>Horas Nocturnas</label>';
    html += '<input type="number" id="editNocturnas" min="0" max="24" step="0.1" value="0" />';
    
    html += '<label>üõèÔ∏è Dieta Pernocta</label>';
    html += '<select id="editDieta">';
    html += `<option value="casa" ${registro.dieta_pernocta === 'casa' ? 'selected' : ''}>En casa</option>`;
    html += `<option value="camion" ${registro.dieta_pernocta === 'camion' ? 'selected' : ''}>En cami√≥n</option>`;
    html += '</select>';
    
    html += '<label class="checkbox-label">';
    html += `<input type="checkbox" id="editFestivo" ${registro.festivo ? 'checked' : ''} /> üéâ Festivo`;
    html += '</label>';
    
    html += '<label class="checkbox-label">';
    html += `<input type="checkbox" id="editSexto" ${registro.sexto ? 'checked' : ''} /> ‚ö° Sexto d√≠a consecutivo`;
    html += '</label>';
    
    html += '</div>';
    
    contenido.innerHTML = html;
    
    diaEditando = fecha;
    document.getElementById('btnGuardarCambios').style.display = 'block';
  }

  document.getElementById('btnGuardarCambios').onclick = function() {
    const inicio = document.getElementById('editInicio').value;
    const fin = document.getElementById('editFin').value;
    const nocturnas = parseFloat(document.getElementById('editNocturnas').value) || 0;
    const dieta = document.getElementById('editDieta').value;
    const festivo = document.getElementById('editFestivo').checked;
    const sexto = document.getElementById('editSexto').checked;
    
    if (!inicio || !fin) {
      alert('Debes completar fecha de inicio y fin');
      return;
    }
    
    const fechaInicio = new Date(inicio);
    const fechaFin = new Date(fin);
    
    if (fechaFin <= fechaInicio) {
      alert('La fecha de fin debe ser posterior a la de inicio');
      return;
    }
    
    // Guardar jornada
    const duracionMs = fechaFin - fechaInicio;
    const duracionHoras = duracionMs / 1000 / 3600;
    
    const jornadas = JSON.parse(localStorage.getItem('jornadas') || '[]');
    jornadas.push({
      fechaInicio: fechaInicio.toISOString(),
      fechaFin: fechaFin.toISOString(),
      tipo: 'trabajo',
      duracion: Math.round(duracionHoras * 100) / 100,
      horasNocturnas: nocturnas,
      timestamp: Date.now()
    });
    localStorage.setItem('jornadas', JSON.stringify(jornadas));
    
    // Guardar registro de dieta
    const registros = JSON.parse(localStorage.getItem('registros') || '[]');
    const indice = registros.findIndex(r => r.fecha === diaEditando);
    
    if (indice >= 0) {
      registros[indice] = {
        fecha: diaEditando,
        dieta_pernocta: dieta,
        festivo: festivo,
        sexto: sexto
      };
    } else {
      registros.push({
        fecha: diaEditando,
        dieta_pernocta: dieta,
        festivo: festivo,
        sexto: sexto
      });
    }
    localStorage.setItem('registros', JSON.stringify(registros));
    
    alert('Cambios guardados correctamente');
    document.getElementById('modalDetalle').style.display = 'none';
    document.getElementById('btnGuardarCambios').style.display = 'none';
    
    // Recargar calendario
    const mes = document.getElementById('mesResumenReal').value;
    if (mes) {
      mostrarCalendario2625(mes);
    }
  };

  // Cerrar modal
  document.getElementById('closeModal').onclick = function() {
    document.getElementById('modalDetalle').style.display = 'none';
    document.getElementById('btnGuardarCambios').style.display = 'none';
  };

  window.onclick = function(event) {
    const modal = document.getElementById('modalDetalle');
    if (event.target === modal) {
      modal.style.display = 'none';
      document.getElementById('btnGuardarCambios').style.display = 'none';
    }
  };

  // ========== INICIALIZACI√ìN ==========
  cargarHistorial();
  cargarEstadoCrono(); // Cargar estado del cron√≥metro al iniciar
</script>

</body>
</html>
